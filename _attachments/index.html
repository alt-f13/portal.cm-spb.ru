<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
    <link rel="stylesheet"
    href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
    integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7"
    crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="css/pickmeup.css" type="text/css" />
    <link href="css/main.css" rel="stylesheet">
    <link rel="stylesheet" href="js/trumbowyg/dist/ui/trumbowyg.min.css">
    <link rel="stylesheet" href="css/index.css">
    <!-- jQuery js -->
    <script src="js/json2/json2.js"></script>
    <script src="js/jquery/dist/jquery.js"></script>
    <script src="js/jquery.couch/jquery.couch.js"></script>
    <script src="js/base64/base64.js" charset="utf-8"></script>
    <!-- <script src="js/jquery-couch/jquery.couch.js" charset="utf-8"></script> -->
    <script src="js/jquery-form/jquery.form.js?0.9.0"></script>
    <script src="js/jquery.tmpl.js" charset="utf-8"></script>
    <script src="js/mindmup-editabletable.js" charset="utf-8"></script>
    <script src="js/jquery.pickmeup.js" charset="utf-8"></script>
    <script type="text/javascript" src="js/pickmeup.js"></script>

    <script src="js/DateJS/build/date-ru-RU.js" charset="utf-8"></script>
    <script src="js/moment.min.js" charset="utf-8"></script>
    <script src="js/trumbowyg/dist/trumbowyg.min.js"></script>
    <script src="js/trumbowyg/dist/langs/ru.min.js" charset="utf-8"></script>
    <script src="js/init.js" charset="utf-8"></script>

    <script type="text/javascript">

      $(function() {
        $('form.documentForm').submit(function(e) {
          $.couch.urlPrefix = "https://couch.2d-it.ru";

          // Prevent submit because we will use ajaxSubmit() to actually send the
    // attachment to CouchDB.
    e.preventDefault();
    // Get the user supplied details
    var input_db = "update"
    var input_id = $('.documentForm input#_id').val()
    var input_rev = $('.documentForm input#_rev').val()

    // Start by trying to open a Couch Doc at the _id and _db specified
    $.couch.db(input_db).openDoc(input_id, {
      // If found, then set the revision in the form and save
      success: function(couchDoc) {
        // Defining a revision on saving over a Couch Doc that exists is required.
        // This puts the last revision of the Couch Doc into the input#rev field
        // so that it will be submitted using ajaxSubmit.
        $('.documentForm input#_rev').val(couchDoc._rev);

        // Submit the form with the attachment
        $('form.documentForm').ajaxSubmit({
          url: "/"+ input_db +"/"+ input_id,
          success: function(response) {
            alert("Your attachment was submitted.")
          }
        })
      }, // End success, we have a Doc

      // If there is no CouchDB document with that ID then we'll need to create it before we can attach a file to it.
      error: function(status) {
        $.couch.db(input_db).saveDoc({"_id":input_id}, {
          success: function(couchDoc) {
            // Now that the Couch Doc exists, we can submit the attachment,
            // but before submitting we have to define the revision of the Couch
            // Doc so that it gets passed along in the form submit.
            $('.documentForm input#_rev').val(couchDoc.rev);
            $('form.documentForm').ajaxSubmit({
              // Submit the form with the attachment
              url: "/"+ input_db +"/"+ input_id,
              success: function(response) {
                alert("Your attachment was submitted.")
              }
            })
          }
        })
      } // End error, no Doc
    }) // End openDoc()
  }) /* End form.documentForm submit */
}) /* End jQuery ready */

</script>
  </head>

  <body>
    <script id="documents" type="text/x-jquery-tmpl">
      <li>${id} ${key}</li>
    </script>
    <div id="pickmeup"></div>
    <form class="documentForm" method="post" action="" enctype="multipart/form-data">
      <input type="text" name="_db" id="_db" placeholder="Database ID" />
      <input type="text" name="_id" id="_id" placeholder="Document ID" />
      <input type="text" name="_rev" id="_rev" placeholder="Revision ID (always overridden in code)" />
      <input type="file" name="_attachments" id="_attachments" multiple="multiple" />
      <input type="submit" class="Submit" value="Submit" />
    </form>
    <table id="dataTable"></table>

    <ul id="list"></ul>
    <script type="text/javascript">
    $('textarea').trumbowyg({
        lang: 'ru'
    });
    </script>
    <script src="js/index.js" charset="utf-8"></script>
  </body>
</html>
