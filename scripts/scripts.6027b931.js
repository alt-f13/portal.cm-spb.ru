"use strict";function transponse(a){return a.map(function(b,c){return a.map(function(a){return a[c]})})}var db_name="gbook",$app=angular.module("angularTestApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","SimpleCouch","720kb.datepicker","ngFileUpload","textAngular","ui.bootstrap","thatisuday.ng-image-gallery","schemaForm","ui.router","ngHandsontable"]).config(["$routeProvider","$httpProvider","couchConfigProvider","ngImageGalleryOptsProvider",function(a,b,c,d){a.when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl",controllerAs:"about"}).when("/post/:id?",{templateUrl:"views/post.html",controller:"PostCtrl",controllerAs:"post"}).when("/posts",{templateUrl:"views/posts.html",controller:"PostsCtrl",controllerAs:"posts"}).when("/links",{templateUrl:"views/links.html",controller:"LinksCtrl",controllerAs:"links"}).when("/scheduler/:day?",{templateUrl:"views/scheduler.html",controller:"SchedulerCtrl",controllerAs:"scheduler"}).otherwise({redirectTo:"/posts"}),"localhost"===location.hostname?c.setServer("/db"):c.setServer("https://couch.2d-it.ru"),c.setDB("cm-spb"),b.defaults.withCredentials=!0}]),db_name="gbook";angular.module("angularTestApp").controller("MainCtrl",["$scope","$filter","couchdb","$uibModal","$cookies","$rootScope",function(a,b,c,d,e,f){var g=a.$db=c;a.session=function(){g.user.session(function(b){console.log("session",b),a.isAuthenticated()})},a.isAuthenticated=function(){g.user.isAuthenticated(function(b){console.log("isAuthenticated",b),a.$emit("authenticated",b),a.$broadcast("authenticated",b),a.authenticated=b})},a.session(),a.logout=function(){g.user.logout(function(b){console.log(b),a.isAuthenticated()})},a.loginModal=function(){console.log(g.user.get()),d.open({templateUrl:"login.html",size:"sm",controller:"LoginCtrl"}).closed.then(function(){a.isAuthenticated()})},a.registerModal=function(){d.open({templateUrl:"register.html",size:"sm",controller:"RegisterCtrl"})}}]).controller("LoginCtrl",["$scope","couchdb","$uibModalInstance","$rootScope",function(a,b,c,d){var e=a.$db=b;a.submitLogin=function(){e.user.login(a.username,a.password,function(a){e.user.isAuthenticated(function(a){console.log("isAuthenticated",a),d.$broadcast("authenticated",a)})}),c.close()},a.close=function(){c.dismiss("cancel")}}]).controller("RegisterCtrl",["$scope","couchdb","$uibModalInstance",function(a,b,c){var d=a.$db=b;a.submitRegistration=function(){d.user.create(a.username,a.password,function(b){console.log(b),d.user.login(a.username,a.password,function(a){d.user.isAuthenticated(function(a){console.log("isAuthenticated",a)})}),c.close()})},a.close=function(){c.dismiss("cancel")}}]),angular.module("angularTestApp").controller("AboutCtrl",["$scope","$filter","couchdb","$location","$routeParams",function(a,b,c,d,e){a.$db=c,a.$db.view("scheduler","posts",{},function(b){console.log(b),a.posts=b})}]);var db_name="gbook";angular.module("angularTestApp").controller("SchedulerCtrl",["$scope","couchdb","$routeParams","$location","hotRegisterer","$rootScope",function(a,b,c,d,e,f){var g=a.$db=b;e.getInstance("my-handsontable");if(a.$on("authenticated",function(b,c){console.log("sheduler authenticated event data:",c),a.authenticated=c}),f._doc={_id:"",_rev:"",grid:{data:{},columns:{}},cellStyle:new Array(10)},a.validRenderer=function(a,b,c,d,e,g,h){return Handsontable.renderers.TextRenderer.apply(this,arguments),f._doc.cellStyle[c]&&null!==f._doc.cellStyle[c]&&"undefined"!=typeof f._doc.cellStyle[c][d]&&(b.style.backgroundColor="#eee",$(b).addClass("edited")),b},a.dates=[],a.location=function(b){d.path("/scheduler/"+b),a.$apply},a.settings={contextMenu:!0,rowHeights:50,stretchH:"all",colWidths:30,rowHeaders:!0,colHeaders:!0,mergeCells:f._doc.grid.mergeCells,onAfterInit:function(){},onAfterChange:function(a,b){a&&"undefined"==f._doc._rev?(console.log("onAfterChange:",f._doc),f._doc.cellStyle||(f._doc.cellStyle=new Array(10)),f._doc.cellStyle[a[0][0]]||(f._doc.cellStyle[a[0][0]]={}),f._doc.cellStyle[a[0][0]][a[0][1]]="grey",g.doc.put(f._doc,function(a){console.log("put:",a),f._doc._rev=a.rev})):a&&"template"==f._doc.type&&g.doc.put(f._doc,function(a){console.log("put:",a),f._doc._rev=a.rev})},contextMenuCopyPaste:{swfPath:"bower_components/zeroclipboard/dist/ZeroClipboard.swf"}},void 0===c.day){var h=Date.today().add(1).days();(h.is().sunday()||h.is().saturday())&&(h=Date.today().next().monday()),a._day=moment(h).unix().toString(),d.path("/scheduler/"+a._day)}else console.log(c),a._day=c.day;moment.locale("en"),a._day_literal=moment.unix(a._day).format("dddd").toLowerCase(),g.doc.get(a._day,function(a){f._doc=a,console.log(a),"template"==a.type&&(a.cellStyle=new Array(10))}).error(function(){g.doc.get(a._day_literal,function(b){moment.locale("ru"),b.date=moment.unix(a._day).format("dddd DD MMMM YYYY"),b._id=a._day,b.type="schedule",b._rev=void 0,b.author=g.user.get().name,b.cellStyle=new Array(10),console.log(b),g.doc.put(b,function(b){console.log("new created:",b),g.doc.get(a._day,function(a){f._doc=a,console.log(a)})})})}),g.view("scheduler","schedules",{},function(b){a.dates=b.map(function(a){return a.id})})}]),angular.module("angularTestApp").filter("trust",["$sce",function(a){return function(b){return a.trustAsHtml(b)}}]),angular.module("angularTestApp").directive("editableTable",function(){return{link:function(a,b,c){b.editableTableWidget(),b.on("change",function(){this.addClass("edited"),console.log(this)}),b.on("change",function(c){a.change(b.html())})}}}),angular.module("angularTestApp").directive("pickmeup",function(){return{link:function(a,b,c,d){new Array;a.$watch(a.dates,function(){b.pickmeup({flat:!0,trigger_event:"click",class_name:"",change:function(b){console.log(b),a.location(moment(b,"DD-MM-YYYY").unix().toString()),a.$apply()},render:function(b){return $.inArray(moment(b).unix().toString(),a.dates)>1?(console.log("highlight"),{class_name:"highlight"}):void 0},locale:{days:["Воскресенье","Понедельник","Вторник","Среда","Четверг","Пятница","Субота","Воскресенье"],daysShort:["Вс","Пн","Вт","Ср","Чт","Пт","Сб","Вс"],daysMin:["Вс","Пн","Вт","Ср","Чт","Пт","Сб","Вс"],months:["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],monthsShort:["Янв","Фев","Март","Апр","Май","Июнь","Июль","Авг","Сент","Окт","Ноя","Дек"]}})})}}}),angular.module("angularTestApp").controller("PostCtrl",["$scope","$filter","couchdb","$location","$routeParams","Upload","$timeout",function(a,b,c,d,e,f,g){a.$db=c,a.details={},a.details._id=e.id,a.docUrl=a.$db.config.getServer()+"/"+a.$db.db.getName()+"/"+e.id+"/",a.$db.doc.get(a.details._id,function(b){a.details=b,console.log(b)}),a.submitEntry=function(){a.details.type="post",console.log(a.details),a.$db.doc.put(a.details,function(b){console.log(b),a.details._rev=b.rev})},a.$watch("files",function(){a.upload(a.files)}),a.$watch("file",function(){null!=a.file&&(a.files=[a.file])}),a.log="",a.upload=function(b){if(b&&b.length)for(var c=0;c<b.length;c++){var d=b[c];console.log(d),d.$error||a.$db.attach.put(a.details,d,{},function(a){console.log(a)})}}}]),angular.module("angularTestApp").directive("ngThumb",["$window",function(a){var b={support:!(!a.FileReader||!a.CanvasRenderingContext2D),isFile:function(b){return angular.isObject(b)&&b instanceof a.File},isImage:function(a){var b="|"+a.type.slice(a.type.lastIndexOf("/")+1)+"|";return-1!=="|jpg|png|jpeg|bmp|gif|".indexOf(b)}};return{restrict:"A",template:"<canvas/>",link:function(a,c,d){function e(a){var b=new Image;b.onload=f,b.src=a.target.result}function f(){var a=g.width||this.width/this.height*g.height,b=g.height||this.height/this.width*g.width;h.attr({width:a,height:b}),h[0].getContext("2d").drawImage(this,0,0,a,b)}if(b.support){var g=a.$eval(d.ngThumb);if(b.isFile(g.file)&&b.isImage(g.file)){var h=c.find("canvas"),i=new FileReader;i.onload=e,i.readAsDataURL(g.file)}}}}}]),angular.module("angularTestApp").controller("PostsCtrl",["$scope","couchdb","$uibModal","session",function(a,b,c,d){var e=a.$db=b;a.$on("authenticated",function(b,c){console.log("posts authenticated event data:",c),a.authenticated=c}),a.update_posts=function(){a.$db.view("scheduler","posts",{},function(b){a.posts=b}),e.uuid(function(b){a.uuid=b.uuids})},a.update_posts(),a.edit=function(b){var d;d=a.authenticated?"edit.html":"show.html",c.open({templateUrl:d,size:"lg",controller:"EditCtrl",resolve:{id:function(){return b}}}).closed.then(function(){a.update_posts()})},a["delete"]=function(a){console.log("deleting: ",a),e.doc.get(a,function(a){console.log(a),e.doc["delete"](a,function(a){console.log("deleted: ",a)})})}}]).controller("EditCtrl",["$scope","couchdb","$uibModalInstance","id","$cookies",function(a,b,c,d,e){var f=a.$db=b;a.details={},f.user.isAuthenticated(function(a){console.log(a)}),a.details._id=d.toString(),a.details.id=a.details._id,a.details.type="post",a.docUrl=a.$db.config.getServer()+"/"+a.$db.db.getName()+"/"+d+"/",a.$db.doc.get(a.details._id,function(b){a.details=b,a.images=[],a.attachments=[],angular.forEach(b._attachments,function(b,c){console.log(b,c),b.content_type.match(/image/)?(console.log(a.images),a.images.push({url:a.docUrl+c})):(a.attachments.push({url:a.docUrl+c,name:c,info:b}),console.log(a.attachments))})}),a.updateAttachments=function(){f.doc.get(a.details._id,function(b){a.details._attachments=b._attachments,console.log(b._attachments)})},a.submitEntry=function(){a.details.type="post",console.log(a.details),a.$db.doc.put(a.details,function(b){console.log(b),a.details._rev=b.rev,c.close()})},a.close=function(){c.dismiss("cancel")},a.$watch("files",function(){a.upload(a.files)}),a.$watch("file",function(){null!=a.file&&(a.files=[a.file])}),a.log="",a.upload=function(b){a.details._rev;console.log(b),a.db_attach(b,0)},a.db_attach=function(b,c){a.$db.attach.put(a.details,b[c],{},function(d){console.log(d),a.details._rev=d.rev,a.updateAttachments(),++c,console.log(a.attachments),a.db_attach(b,c)})}}]),angular.module("angularTestApp").factory("session",function(){return{authenticated:""}}),angular.module("angularTestApp").controller("LinksCtrl",["$scope","couchdb",function(a,b){var c=a.$db=b;a.getLinks=function(){a.$db.view("scheduler","links",{},function(b){a.docs=b,console.log(b)}),c.uuid(function(b){a.uuid=b.uuids})},a.getLinks(),a.submitEntry=function(){a.link.type="link",a.link._id=a.uuid.toString(),a.$db.doc.put(a.link,function(b){console.log(b),a.getLinks()})}}]),angular.module("angularTestApp").run(["$templateCache",function(a){a.put("views/about.html",'<div class="list-group" ng-repeat="post in posts"> <a href="#" class="list-group-item active"> <h4 class="list-group-item-heading">List group item heading</h4> <p class="list-group-item-text">...</p> </a> </div>'),a.put("views/links.html",'<ul> <li ng-repeat="doc in docs"> <a href="{{doc.value.href}}" class="link-icon">{{doc.value.title}}</a> </li> </ul> <form ng-submit="submitEntry()"> <div class="row"> <div class="col-md-3"> <div class="input-group"> <span class="input-group-addon" style="cursor: pointer"> <i class="fa fa-lg fa-anchor"></i> </span> <input class="form-control" type="text" ng-model="link.title" placeholder="Название"> </div> </div> <div class="col-md-3"> <div class="input-group"> <span class="input-group-addon" style="cursor: pointer"> <i class="fa fa-lg fa-link"></i> </span> <input class="form-control" type="text" ng-model="link.href" placeholder="href"> </div> </div> <div class="col-md-3"></div> <div class="col-md-3"> <button type="button" class="btn btn-primary" ng-click="submitEntry()">Сохранить</button> </div> </div> </form> <script type="text/ng-template" id="edit.html"><form role="form" name="formdetails" class="offset1 span9" ng-submit="submitEntry()">\n  <div class="modal-header">\n    <div class="row">\n      <div class="col-md-8">\n        <div class="input-group">\n          <span class="input-group-addon">\n            <input type="checkbox" aria-label="опубликованно" ng-model="details.published">\n          </span>\n          <input type="text" class="form-control" placeholder="Название" aria-describedby="basic-addon1" ng-model="details.title">\n        </div><!-- /input-group -->\n      </div>\n      <div class="col-md-2">\n          <div class="input-group">\n            <span class="input-group-addon" style="cursor: pointer">\n                <i class="fa fa-lg fa-calendar"></i>\n            </span>\n            <datepicker date-format="dd/MM/yyyy">\n              <input class="form-control" type="text" ng-model="details.date" placeholder="Choose a date"/>\n            </datepicker>\n\n          </div>\n      </div>\n      <div class="col-md-1">\n        <button type="button" class="btn btn-primary" ng-click="submitEntry()">Сохранить</button>\n      </div>\n      <div class="col-md-1">\n        <button type="button" class="close"  ng-click="close() " aria-label="Close"><span aria-hidden="true">&times;</span></button>\n      </div>\n\n    </div>\n\n  </div>\n  <div class="modal-body ">\n\n    <div class="row edit">\n      <div class="col-md-10">\n        <div class="form-group">\n           <text-angular  ng-model="details.body" ></text-angular>\n        </div>\n      </div>\n      <div class="col-md-2 attachments"  ngf-drop ng-model="files"\n          ngf-drag-over-class="\'dragover\'" ngf-multiple="true" ngf-allow-dir="true"\n          accept="image/*,application/pdf"\n          ngf-pattern="\'image/*,application/pdf\'">\n        <ul>\n          <li>\n\n                    <div  ngf-drop ngf-select ng-model="files" class="drop-box"\n                        ngf-drag-over-class="\'dragover\'" ngf-multiple="true" ngf-allow-dir="true"\n                        accept="image/*,application/pdf"\n                        ngf-pattern="\'image/*,application/pdf\'">Drag-drop сюда или нажмите для загрузки</div>\n                    <div ngf-no-file-drop>File Drag/Drop is not supported for this browser</div>\n          </li>\n          <li ng-repeat="(name,info) in details._attachments" >\n            <div class="thumbnail" ng-switch="info.content_type==\'image/png\'||info.content_type==\'image/jpeg\'">\n              <img ng-switch-when="true" ng-switch-when-separator="|" src="{{docUrl}}{{name}}" alt="">\n              <div class="caption">\n                {{name}}\n              </div>\n            </div>\n          </li>\n        </ul>\n      </div>\n    </div>\n\n  </div>\n  <div class="modal-footer">\n    <button type="button" class="btn btn-default" ng-click="close()">Закрыть</button>\n    <button type="button" class="btn btn-primary" ng-click="submitEntry()">Сохранить</button>\n  </div>\n</form></script>'),a.put("views/login.html",""),a.put("views/post.html",'<form role="form" name="formdetails" class="offset1 span9" ng-submit="submitEntry()"> <fieldset> <div class="form-group"> <label for="detailsAlias">Название</label> <input type="text" id="mewEntryAlias" class="span4 form-control" ng-model="details.title" required> </div> <div class="form-group"> <label for="detailsEmail">Дата</label> <input type="text" id="detailsEmail" class="span4 form-control" ng-model="details.date"> </div> <div class="form-group"> <label for="detailsSubject">теги</label> <input type="text" id="detailsSubject" class="span9 form-control" ng-model="details.tags" required> </div> <div class="form-group"> <label for="detailsBody">Послание</label> <textarea rows="5" id="detailsBody" class="span9 form-control" ng-model="details.body"></textarea> </div> </fieldset> <button class="btn" data-dismiss="modal">Close</button> <button class="btn btn-primary" type="submit">Submit</button> </form> <ul ng-repeat="(name,info) in details._attachments"> <li><img src="{{docUrl}}{{name}}" alt=""></li> </ul> <input type="text" ng-model="username"><br><br> watching model: <div class="button" ngf-select ng-model="file" ngf-multiple="false">Select File</div> on file change multiple: <div class="button" ngf-select="upload($files)" ngf-multiple="true">Select File</div> Drop File: <div ngf-drop ngf-select ng-model="files" class="drop-box" ngf-drag-over-class="\'dragover\'" ngf-multiple="true" ngf-allow-dir="true" accept="image/*,application/pdf" ngf-pattern="\'image/*,application/pdf\'">Drop pdfs or images here or click to upload</div> <div ngf-no-file-drop>File Drag/Drop is not supported for this browser</div> Files: <ul> <li ng-repeat="f in files" style="font:smaller">{{f.name}} {{f.$error}} {{f.$errorParam}}</li> </ul> Upload Log: <pre>{{log}}</pre> '),a.put("views/posts.html",'<script type="text/ng-template" id="edit.html"><form role="form" name="formdetails" class="offset1 span9" ng-submit="submitEntry()">\n  <div class="modal-header">\n    <div class="row">\n      <div class="col-md-8">\n        <div class="input-group">\n          <span class="input-group-addon">\n            <input type="checkbox" aria-label="опубликованно" ng-model="details.published">\n          </span>\n          <input type="text" class="form-control" placeholder="Название" aria-describedby="basic-addon1" ng-model="details.title">\n        </div><!-- /input-group -->\n      </div>\n      <div class="col-md-2">\n          <div class="input-group">\n            <span class="input-group-addon" style="cursor: pointer">\n                <i class="fa fa-lg fa-calendar"></i>\n            </span>\n            <datepicker date-format="dd/MM/yyyy">\n              <input class="form-control" type="text" ng-model="details.date" placeholder="Choose a date"/>\n            </datepicker>\n\n          </div>\n      </div>\n      <div class="col-md-1">\n        <button type="button" class="btn btn-primary" ng-click="submitEntry()">Сохранить</button>\n      </div>\n      <div class="col-md-1">\n        <button type="button" class="close"  ng-click="close() " aria-label="Close"><span aria-hidden="true">&times;</span></button>\n      </div>\n\n    </div>\n\n  </div>\n  <div class="modal-body ">\n\n    <div class="row edit">\n      <div class="col-md-10">\n        <div class="form-group">\n           <text-angular  ng-model="details.body" ></text-angular>\n        </div>\n      </div>\n      <div class="col-md-2 attachments"  ngf-drop ng-model="files"\n          ngf-drag-over-class="\'dragover\'" ngf-multiple="true" ngf-allow-dir="true"\n          accept="image/*,application/pdf"\n          ngf-pattern="\'image/*,application/pdf\'">\n        <ul>\n          <li>\n\n                    <div  ngf-drop ngf-select ng-model="files" class="drop-box"\n                        ngf-drag-over-class="\'dragover\'" ngf-multiple="true" ngf-allow-dir="true"\n                        accept="image/*,application/pdf"\n                        ngf-pattern="\'image/*,application/pdf\'">Drag-drop сюда или нажмите для загрузки</div>\n                    <div ngf-no-file-drop>File Drag/Drop is not supported for this browser</div>\n          </li>\n          <li ng-repeat="(name,info) in details._attachments" >\n            <div class="thumbnail" ng-switch="info.content_type==\'image/png\'||info.content_type==\'image/jpeg\'">\n              <img ng-switch-when="true" ng-switch-when-separator="|" src="{{docUrl}}{{name}}" alt="">\n              <div class="caption">\n                {{name}}\n              </div>\n            </div>\n          </li>\n        </ul>\n      </div>\n    </div>\n\n  </div>\n  <div class="modal-footer">\n    <button type="button" class="btn btn-default" ng-click="close()">Закрыть</button>\n    <button type="button" class="btn btn-primary" ng-click="submitEntry()">Сохранить</button>\n  </div>\n</form></script> <script type="text/ng-template" id="show.html"><div class="modal-header">\n    <div class="row">\n      <div class="col-md-8">\n        {{details.title}}\n      </div>\n      <div class="col-md-2">\n        {{details.date}}\n      </div>\n\n      <div class="col-md-1">\n        <button type="button" class="close"  ng-click="close() " aria-label="Close"><span aria-hidden="true">&times;</span></button>\n      </div>\n\n    </div>\n\n  </div>\n  <div class="modal-body" >\n    <div class="row">\n      <div class="col-md-12">\n        <div ng-bind-html="details.body|trust"></div>\n      </div>\n    </div>\n    <div class="row">\n      <div class="col-md-12">\n        <ng-image-gallery\n            images="images"\n            thumbnails="true"\n            inline="false"\n            bg-close="true"\n            bubbles="true"\n            img-anim="fadeup"\n            on-open="opened();"\n            on-close="closed();"\n        ></ng-image-gallery>\n      </div>\n    </div>\n    <div class="row">\n      <div class="col-md-12">\n        <ul class="attachments">\n          <li ng-repeat="(index,info) in attachments" >\n            <a class="link-icon" ng-href="{{info.url}}">{{info.name}}</a>\n          </li>\n        </ul>\n      </div>\n    </div>\n\n  </div>\n  <div class="modal-footer">\n    <button type="button" class="btn btn-default" ng-click="close()">Закрыть</button>\n  </div></script> <a ng-click="edit(uuid)" ng-show="authenticated" role="button" class="btn btn-success">Новый пост</a> <div class="list-group"> <a class="list-group-item" ng-click="edit(post.id)" ng-repeat="post in posts"> <h4 class="list-group-item-heading">{{post.value.date}} {{post.value.title}} <button class="btn btn-danger pull-right" ng-show="authenticated" ng-click="delete(post.id)"><i class="fa fa-trash-o"></i></button> </h4> <p class="list-group-item-text" ng-bind-html="post.value.body|trust"></p> </a> </div>'),a.put("views/scheduler.html",'<div class="container"> <h2>Расписание <span class="pull-right">{{_doc.date}}</span><h2> <a href="javascript:window.print()" role="button" class="btn btn-primary active print-hidden pull-right"> <i class="fa fa-3x fa-print" aria-hidden="true"></i> </a> </h2></h2></div> <div class="container-fluid" ng-controller="SchedulerCtrl"> <div class="row"> <div class="col-md-2"> <div pickmeup></div> </div> <div class="col-md-10"> <hot-table hot-id="my-handsontable" datarows="_doc.grid.data" settings="settings" col-headers="_doc.grid.columns" row-headers="true" mergecells="_doc.grid.mergeCells"> <hot-column ng-repeat="column in _doc.grid.columns" title="column" renderer="validRenderer"></hot-column> </hot-table> </div> </div> </div> <div class="container footer"> <a role="button" ng-href="#/scheduler/monday" class="btn btn-default">Понедельник <a role="button" ng-href="#/scheduler/tuesday" class="btn btn-default">Вторник <a role="button" ng-href="#/scheduler/wednesday" class="btn btn-default">Среда <a role="button" ng-href="#/scheduler/thursday" class="btn btn-default">Четверг <a role="button" ng-href="#/scheduler/friday" class="btn btn-default">Пятница </a></a></a></a></a></div>')}]);